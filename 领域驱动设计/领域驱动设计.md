# 领域模型

2004年Eric Evans 发表Domain-Driven Design –Tackling Complexity in the Heart of Software （领域驱动设计），简称Evans DDD。领域驱动设计分为两个阶段： 

1. 以一种领域专家、设计人员、开发人员都能理解的“通用语言”作为相互交流的工具，在不断交流的过程中不断发现一些主要的领域概念，然后将这些概念设计成一个领域模型；
2. 由领域模型驱动软件设计，用代码来表现该领域模型。 

由此可见，**领域驱动设计的核心是建立领域模型。领域模型在软件架构中处于核心地位；软件开发过程中，必须以建立领域模型为中心。** 

## 领域模型的特点

领域驱动设计告诉我们，在通过软件实现一个业务系统时，建立一个领域模型是非常重要和必要的，因为领域模型具有以下特点： 

1. 领域模型是对具有某个边界的领域的一个抽象，反映了领域内用户业务需求的本质；领域模型是有边界的，只反应了我们在领域内所关注的部分；
2.  领域模型只反映业务，和任何技术实现无关；领域模型不仅能反映领域中的一些实体概念，如货物，书本，应聘记录，地址，等；还能反映领域中的一些过程概念，如资金转账，等； 
3. 领域模型确保了我们的软件的业务逻辑都在一个模型中，都在一个地方；这样对提高软件的可维护性，业务可理解性以及可重用性方面都有很好的帮助； 
4. 领域模型能够帮助开发人员相对平滑地将领域知识转化为软件构造；
5. 领域模型贯穿软件分析、设计，以及开发的整个过程；领域专家、设计人员、开发人员通过领域模型进行交流，彼此共享知识与信息；因为大家面向的都是同一个模型， 所以可以防止需求走样，可以让软件设计开发人员做出来的软件真正满足需求； 
6. 要建立正确的领域模型并不简单，需要领域专家、设计、开发人员积极沟通共同努力，然后才能使大家对领域的认识不断深入，从而不断细化和完善领域模型； 
7. 为了让领域模型看的见，我们需要用一些方法来表示它；图是表达领域模型最常用的方式，但不是唯一的表达方式，代码或文字描述也能表达领域模型； 
8. 领域模型是整个软件的核心，是软件中最有价值和最具竞争力的部分；设计足够精良且符合业务需求的领域模型能够更快速的响应需求变化； 

## 领域通用语言（Ubiquitous Language） 

​		领域驱动设计的一个核心的原则是使用一种基于模型的语言。因为模型是软件满足领域的共同点，它很适合作为这种通用语言的构造基础。使用模型作为语言的核心骨架，要求团队在进行所有的交流是都使用一致的语言，在代码中也是这样。在共享知识和推敲模型时，团队会使用演讲、文字和图形。这儿需要确保团队使用的语言在所有的交流形式中看上去都是一致的，这种语言被称为“通用语言（Ubiquitous Language）”。通用语言应该在建模过程中广泛尝试以推动软件专家和领域专家之间的沟通，从而发现要在模型中使用的主要的领域概念。



#  聚合及聚合根

聚合，**它通过定义对象之间清晰的所属关系和边界来实现领域模型的内聚，并避免了错综复杂的难以维护的对象关系网的形成。聚合定义了一组具有内聚关系的相关对象的集合，我们把聚合看作是一个修改数据的单元。** 

## 聚合的特点

1. 每个聚合有一个根和一个边界，边界定义了一个聚合内部有哪些实体或值对象，根是聚合内的某个实体； 
2. 聚合内部的对象之间可以相互引用，但是聚合外部如果要访问聚合内部的对象时，必须通过聚合根开始导航，绝对不能绕过聚合根直接访问聚合内的对象，也就是说聚合根是外部可以保持 对它的引用的唯一元素； 
3. 聚合内除根以外的其他实体的唯一标识都是本地标识，也就是只要在聚合内部保持唯一即可，因为它们总是从属于这个聚合的； 
4. 聚合根负责与外部其他对象打交道并维护自己内部的业务规则； 
5. 基于聚合的以上概念，我们可以推论出从数据库查询时的单元也是以聚合为一个单元，也就是说我们不能直接查询聚合内部的某个非根的对象； 
6.  聚合内部的对象可以保持对其他聚合根的引用； 
7.   删除一个聚合根时必须同时删除该聚合内的所有相关对象，因为他们都同属于一个聚合，是一个完整的概念； 

## 聚合根、实体和值对象区别

1. 从标识角度：
  1. 聚合根拥有唯一标识；
  2. 实体在聚合根下拥有唯一标识；
  3. 值对象没有唯一标识；
2. 从只读角度：
   1. 聚合根除了唯一标识外，其他所有状态信息都理论上可变；
   2. 实体是可变的；
   3. 值对象只读。
3. 从生命周期的角度：
   1. 聚合根有独立的生命周期；
   2. 实体的生命周期从属于其所属的聚合，实体完全由其所属的聚合根负责管理维护；
   3. 值对象无生命周期可言，因为只是一个值。

##  聚合根、实体和值对象建立关系

- 聚合根到聚合根：通过ID关联；
- 聚合根到其内部的实体，直接对象引用；
- 聚合根到值对象，直接对象引用；
- 实体对其他对象的引用规则：
  - 能引用其所属聚合内的聚合根、实体、值对象；
  - 能引用外部聚合根，但推荐以ID的方式关联，另外也可以关联某个外部聚合内的实体，但必须是ID关联，否则就出现同一个实体的引用被两个聚合根持有，这是不允许的，**一个实体的引用只能被其所属的聚合根持有**。
- 值对象对其他对象的引用规则：只需确保值对象是只读的即可，推荐值对象的所有属性都尽量是值对象。

## 如何识别聚合和聚合根

一个Bounded Context（界定的上下文）可能包含多个聚合，每个聚合都有一个根实体，叫做聚合根；

1. 识别顺序：
   1. 先找出哪些实体可能是聚合根，
   2. 再逐个分析每个聚合根的边界，
   3. 即该聚合根应该聚合哪些实体或值对象； 
   4. 最后再划分Bounded Context；
2. 聚合边界确定法则：根据不变性约束规则（Invariant）
3. 不变性规则有两类：
   1. 聚合边界内必须具有哪些信息，如果没有这些信息就不能称为一个有效的聚合；
   2. 聚合内的某些对象的状态必须满足某个业务规则；

